From d094ab58faec060beaf4a672b9037d3a0d036965 Mon Sep 17 00:00:00 2001
From: "A.I" <ailis@paw.zone>
Date: Mon, 20 Jun 2016 18:59:52 -0700
Subject: [PATCH] Add a patch for regops.c

- based on http://d.hatena.ne.jp/hiboma/20140320/1395312958
---
 regops.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/regops.c b/regops.c
index 1fef7f9..b2cded7 100644
--- a/regops.c
+++ b/regops.c
@@ -554,6 +554,14 @@ static int sf_reg_mmap(struct file *file, struct vm_area_struct *vma)
     return 0;
 }
 
+ssize_t sf_reg_splice_read(struct file *in, loff_t *ppos,
+                           struct pipe_inode_info *pipe, size_t len,
+                           unsigned int flags)
+{
+    invalidate_mapping_pages(in->f_mapping, 0, -1);
+    return generic_file_splice_read(in, ppos, pipe, len, flags);
+}
+
 struct file_operations sf_reg_fops =
 {
     .read        = sf_reg_read,
@@ -566,7 +574,7 @@ struct file_operations sf_reg_fops =
 /** @todo This code is known to cause caching of data which should not be
  * cached.  Investigate. */
 #  if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 23)
-    .splice_read = generic_file_splice_read,
+    .splice_read = sf_reg_splice_read,
 #  else
     .sendfile    = generic_file_sendfile,
 #  endif
-- 
2.14.1

